<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¢ØªØ´ | ÙˆØ¶Ø¹ÛŒØª Ø¬Ø§Ø±ÛŒ</title>

  <!-- Mazer CSS (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/zuramai/mazer@docs/demo/assets/compiled/css/app.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/zuramai/mazer@docs/demo/assets/compiled/css/app-dark.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- Leaflet Draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>

  <style>
    :root{
      --navy:#111a4a;
      --navy2:#0c1338;
      --gold:#f59e0b;
      --panel:#0f172a;
      --panel2:#0b1220;
      --muted:#94a3b8;
      --line:rgba(148,163,184,.14);
      --soft:rgba(255,255,255,.06);
      --white: #fff;
    }

    html, body { height: 100%; margin: 0; }
    body { background: var(--panel2); font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; }

    .topbar{
      height: 64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      background: linear-gradient(90deg, var(--navy2), var(--navy));
      color:#fff;
      position:sticky;
      top:0;
      z-index:1200;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .topbar .title{
      font-weight:800;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      font-size:12px;
      color:#e5e7eb;
    }
    .chip .dot{
      width:8px; height:8px; border-radius:50%;
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34,197,94,.12);
    }

    .app-shell{
      height: calc(100vh - 64px);
      position: relative;
      background: var(--panel2);
    }
    #map{ height:100%; width:100%; }

    /* Custom left toolbar (ONLY ours) */
    .left-tools{
      position:absolute;
      top: 16px;
      left: 16px;
      z-index: 1100;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .tool-btn{
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(17,26,74,.96), rgba(12,19,56,.96));
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      color:#e5e7eb;
      font-weight:800;
      transition: transform .12s ease, filter .12s ease;
    }
    .tool-btn:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    .tool-btn:active{ transform: translateY(0px); }
    .tool-btn small{ font-weight:700; font-size:11px; opacity:.9; }
    .tool-btn.gold{
      background: linear-gradient(180deg, rgba(245,158,11,.98), rgba(217,119,6,.98));
      color:#1f2937;
      border: 1px solid rgba(0,0,0,.08);
    }

    /* Sidebar (drawer) */
    .sidebar{
      position:absolute;
      top: 12px;
      right: 12px;
      z-index: 1150;
      width: 380px;
      max-height: calc(100% - 24px);
      background: rgba(15,23,42,.88);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      border-radius: 14px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      backdrop-filter: blur(10px);
      transform: translateX(0);
      transition: transform .18s ease;
    }
    .sidebar.collapsed{
      transform: translateX(calc(100% - 52px));
    }

    .sidebar-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      background: rgba(255,255,255,.04);
      border-bottom: 1px solid var(--line);
    }
    .sidebar-header .h{
      color:#e5e7eb;
      font-weight:900;
      font-size: 13px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sidebar-header .sub{
      color: var(--muted);
      font-size: 11px;
      margin-top:2px;
    }
    .sidebar-toggle{
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display:grid;
      place-items:center;
      cursor:pointer;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      color:#e5e7eb;
      font-weight:900;
      user-select:none;
    }

    .sidebar-body{
      padding: 12px;
      overflow:auto;
    }

    .section{
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .section-title .t{
      color:#e5e7eb;
      font-weight:900;
      font-size: 12px;
      letter-spacing:.6px;
      text-transform: uppercase;
      opacity:.95;
    }
    .section-title .pill{
      font-size: 11px;
      color: var(--muted);
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.35);
      white-space:nowrap;
    }

    .help{
      color: var(--muted);
      font-size: 11px;
      line-height: 1.55;
      margin-top: 6px;
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    label{
      color:#e5e7eb;
      font-size: 11px;
      margin-bottom: 4px;
      display:block;
      opacity:.9;
    }

    select, input[type="date"], input[type="text"], input[type="number"]{
      width:100%;
      background: rgba(2,6,23,.45);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 10px;
      color:#e5e7eb;
      padding: 8px 10px;
      outline:none;
      font-size: 12px;
    }

    .btnx{
      width:100%;
      border:none;
      border-radius: 10px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight:900;
      font-size: 12px;
      letter-spacing:.2px;
    }
    .btnx.primary{
      background: linear-gradient(180deg, rgba(245,158,11,.98), rgba(217,119,6,.98));
      color:#111827;
    }
    .btnx.secondary{
      background: rgba(255,255,255,.06);
      color:#e5e7eb;
      border: 1px solid rgba(255,255,255,.10);
    }

    /* Base layer radios (checkbox look, radio logic) */
    .radio-list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .radio-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(2,6,23,.35);
      border: 1px solid rgba(255,255,255,.06);
    }
    .radio-item .name{
      color:#e5e7eb;
      font-size: 12px;
      font-weight:800;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .fake-box{
      width: 16px;
      height: 16px;
      border-radius: 5px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.04);
      display:inline-block;
      position:relative;
      flex: 0 0 auto;
    }
    .radio-item input{ display:none; }
    .radio-item input:checked + .fake-box{
      border-color: rgba(245,158,11,.85);
      box-shadow: 0 0 0 3px rgba(245,158,11,.14);
    }
    .radio-item input:checked + .fake-box::after{
      content:"";
      position:absolute;
      inset:3px;
      border-radius: 3px;
      background: rgba(245,158,11,.92);
    }

    /* Layers dropdown (hover) */
    .layers-menu{
      position:relative;
      display:block;
    }
    .layers-trigger{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px;
      border-radius: 12px;
      background: rgba(2,6,23,.35);
      border: 1px solid rgba(255,255,255,.06);
      cursor: default;
      user-select:none;
      color:#e5e7eb;
      font-weight:900;
      font-size: 12px;
    }
    .layers-trigger span{ color: var(--muted); font-weight:700; font-size:11px; }
    .layers-dropdown{
      position:absolute;
      top: 46px;
      right: 0;
      left: 0;
      background: rgba(15,23,42,.95);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      box-shadow: 0 14px 45px rgba(0,0,0,.35);
      padding: 8px;
      display:none;
      z-index: 2000;
    }
    .layers-menu:hover .layers-dropdown{
      display:block;
    }
    .dd-item{
      padding: 10px 10px;
      border-radius: 10px;
      cursor:pointer;
      color:#e5e7eb;
      font-weight:800;
      font-size:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .dd-item:hover{
      background: rgba(255,255,255,.06);
    }
    .dd-item .meta{
      color: var(--muted);
      font-weight:700;
      font-size: 11px;
    }

    /* Layer list toggles */
    .layer-list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .layer-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px;
      border-radius: 12px;
      background: rgba(2,6,23,.35);
      border: 1px solid rgba(255,255,255,.06);
    }
    .layer-row .txt{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 0;
    }
    .layer-row .txt b{
      color:#e5e7eb;
      font-size: 12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .layer-row .txt small{
      color: var(--muted);
      font-size: 11px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .switch{
      width: 44px;
      height: 24px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      position:relative;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .switch::after{
      content:"";
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(255,255,255,.90);
      position:absolute;
      top: 50%;
      transform: translateY(-50%);
      right: 3px;
      transition: right .14s ease, background .14s ease;
    }
    .switch.on{
      background: rgba(245,158,11,.22);
      border-color: rgba(245,158,11,.35);
    }
    .switch.on::after{
      right: 23px;
      background: rgba(245,158,11,.95);
    }

    /* Keep Leaflet draw controls hidden (we use our toolbar button) */
    .leaflet-draw{
      display:none !important;
    }

    /* Make Leaflet attribution subtle */
    .leaflet-control-attribution{
      background: rgba(0,0,0,.35) !important;
      color: rgba(255,255,255,.75) !important;
      border-radius: 10px !important;
      border: 1px solid rgba(255,255,255,.10) !important;
      padding: 4px 8px !important;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="title">
      <span>ÙˆØ¶Ø¹ÛŒØª Ø¬Ø§Ø±ÛŒ Ø¢ØªØ´â€ŒØ³ÙˆØ²ÛŒ (Ø¯Ù…Ùˆ)</span>
      <span class="chip"><span class="dot"></span> Auth: token ok</span>
      <span class="chip">Fire</span>
    </div>
    <div style="opacity:.9;font-size:12px;color:#e5e7eb;">
      Map Viewer + AOI + Layers
    </div>
  </div>

  <div class="app-shell">
    <div id="map"></div>

    <!-- ONLY our toolbar (Leaflet zoom removed) -->
    <div class="left-tools">
      <div class="tool-btn" id="zoomIn" title="Ø¨Ø²Ø±Ú¯Ù†Ù…Ø§ÛŒÛŒ">+</div>
      <div class="tool-btn" id="zoomOut" title="Ú©ÙˆÚ†Ú©Ù†Ù…Ø§ÛŒÛŒ">âˆ’</div>
      <div class="tool-btn" id="home" title="Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù†Ù…Ø§ÛŒ Ø§ÛŒØ±Ø§Ù†">âŒ‚</div>
      <div class="tool-btn gold" id="drawAOI" title="Ø±Ø³Ù… Ù…Ø­Ø¯ÙˆØ¯Ù‡ (AOI)"><small>AOI</small></div>
      <div class="tool-btn" id="clearAOI" title="Ø­Ø°Ù Ù…Ø­Ø¯ÙˆØ¯Ù‡">ğŸ—‘</div>
    </div>

    <!-- Sidebar Drawer -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div>
          <div class="h">Ù¾Ù†Ù„ Ø¹Ù…Ù„ÛŒØ§Øª Ø¢ØªØ´â€ŒØ³ÙˆØ²ÛŒ (Ø¯Ù…Ùˆ)</div>
          <div class="sub">Base + AOI + Layers</div>
        </div>
        <div class="sidebar-toggle" id="sidebarToggle" title="Ø¬Ù…Ø¹/Ø¨Ø§Ø²">â¯</div>
      </div>

      <div class="sidebar-body">

        <!-- BASE (radio logic, checkbox look) -->
        <div class="section">
          <div class="section-title">
            <div class="t">Ù¾Ø§ÛŒÙ‡ Ù†Ù‚Ø´Ù‡ (Base)</div>
            <div class="pill">Radio Logic</div>
          </div>

          <div class="radio-list">
            <label class="radio-item" style="cursor:pointer;">
              <span class="name">OSM</span>
              <span style="display:flex;align-items:center;gap:8px;">
                <input type="radio" name="basemap" id="bm_osm" checked>
                <span class="fake-box"></span>
              </span>
            </label>

            <label class="radio-item" style="cursor:pointer;">
              <span class="name">Satellite (Esri)</span>
              <span style="display:flex;align-items:center;gap:8px;">
                <input type="radio" name="basemap" id="bm_sat">
                <span class="fake-box"></span>
              </span>
            </label>
          </div>

          <div class="help">
            ÙÙ‚Ø· ÛŒÚ©ÛŒ Ø§Ø² BaseMapÙ‡Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯ (Radio). Ù‡Ù…Ø²Ù…Ø§Ù† Ø±ÙˆØ´Ù† Ù†Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
          </div>
        </div>

        <!-- KML / DRAW (KEEP â€“ do not touch UI logic) -->
        <div class="section" id="kmlSection">
          <div class="section-title">
            <div class="t">Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ø¹Ù…Ù„ÛŒØ§Øª (AOI)</div>
            <div class="pill">KML / DRAW</div>
          </div>

          <div class="row2" style="margin-bottom:8px;">
            <button class="btnx primary" id="applyAoiBtn">Ø§Ø¹Ù…Ø§Ù„ Ø±ÙˆÛŒ Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§</button>
            <button class="btnx secondary" id="removeAoiBtn">Ø­Ø°Ù Ù…Ø­Ø¯ÙˆØ¯Ù‡</button>
          </div>

          <label>Ø¢Ù¾Ù„ÙˆØ¯ KML</label>
          <input type="file" id="kmlFile" accept=".kml" />

          <div class="help">
            ÙØ¹Ù„Ø§Ù‹ Ø¢Ù¾Ù„ÙˆØ¯ KML ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ø§Ø³Øª (API Ù‡Ù†ÙˆØ² ÙˆØµÙ„ Ù†Ø´Ø¯Ù‡).  
            Ø§Ø¨Ø²Ø§Ø± Ø±Ø³Ù… Ù¾Ù„ÛŒÚ¯ÙˆÙ† Ø§Ø² Ø¯Ú©Ù…Ù‡ AOI Ø³Ù…Øª Ú†Ù¾ Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª.
          </div>
        </div>

        <!-- STYLE (used for vector overlays) -->
        <div class="section" id="styleSection" style="display:none;">
          <div class="section-title">
            <div class="t">Ø§Ø³ØªØ§ÛŒÙ„ Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø±Ø¯Ø§Ø±ÛŒ</div>
            <div class="pill">STYLE</div>
          </div>

          <div class="row2">
            <div>
              <label>Ø±Ù†Ú¯ Ø®Ø·</label>
              <input type="text" id="strokeColor" value="#22c55e" />
            </div>
            <div>
              <label>Ø±Ù†Ú¯ Ù¾Ø±Ú©Ø±Ø¯Ù†</label>
              <input type="text" id="fillColor" value="#16a34a" />
            </div>
          </div>

          <div class="row2" style="margin-top:10px;">
            <div>
              <label>Ø¶Ø®Ø§Ù…Øª</label>
              <input type="number" id="strokeWidth" value="2" min="1" max="10" />
            </div>
            <div>
              <label>Ø´ÙØ§ÙÛŒØª</label>
              <input type="number" id="fillOpacity" value="0.15" min="0" max="1" step="0.05" />
            </div>
          </div>

          <button class="btnx secondary" style="margin-top:10px;" id="applyStyleBtn">Ø§Ø¹Ù…Ø§Ù„ Ø§Ø³ØªØ§ÛŒÙ„</button>
          <div class="help">Ø§ÛŒÙ† Ø§Ø³ØªØ§ÛŒÙ„ Ø±ÙˆÛŒ Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø±Ø¯Ø§Ø±ÛŒ ÙØ¹Ø§Ù„ (Ø§Ø³ØªØ§Ù†/Ø´Ù‡Ø±Ø³ØªØ§Ù†/Ø¬Ù†Ú¯Ù„/...) Ø§Ø¹Ù…Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
        </div>

        <!-- Layers Dropdown + dynamic config -->
        <div class="section">
          <div class="section-title">
            <div class="t">Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§</div>
            <div class="pill">Hover Dropdown</div>
          </div>

          <div class="layers-menu">
            <div class="layers-trigger">
              Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡ Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§
              <span>Ù…ÙˆØ³ Ø±Ø§ Ù†Ú¯Ù‡ Ø¯Ø§Ø± / Hover</span>
            </div>

            <div class="layers-dropdown" id="layersDropdown">
              <div class="dd-item" data-panel="panel_sat">
                ØªØµØ§ÙˆÛŒØ± Ù…Ø§Ù‡ÙˆØ§Ø±Ù‡â€ŒØ§ÛŒ
                <span class="meta">Satellite</span>
              </div>
              <div class="dd-item" data-panel="panel_county">
                Ù…Ø±Ø² Ø´Ù‡Ø±Ø³ØªØ§Ù†â€ŒÙ‡Ø§
                <span class="meta">Vector</span>
              </div>
              <div class="dd-item" data-panel="panel_province">
                Ù…Ø±Ø² Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§
                <span class="meta">Vector</span>
              </div>
              <div class="dd-item" data-panel="panel_forest">
                Ø¬Ù†Ú¯Ù„â€ŒÙ‡Ø§
                <span class="meta">Vector</span>
              </div>
              <div class="dd-item" data-panel="panel_index">
                Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§
                <span class="meta">Index</span>
              </div>
            </div>
          </div>

          <div class="help">
            Ø±ÙˆÛŒ Ù‡Ø± Ø¯Ø³ØªÙ‡ Ú©Ù„ÛŒÚ© Ú©Ù† ØªØ§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÙ‡ Ø¨Ø§Ø² Ø´ÙˆØ¯. Ú†Ù†Ø¯ Ù„Ø§ÛŒÙ‡ Ø±Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù† Ø±ÙˆØ´Ù†/Ø®Ø§Ù…ÙˆØ´ Ú©Ù†ÛŒ.
          </div>
        </div>

        <!-- Dynamic Panels -->
        <div class="section" id="panel_sat" style="display:none;">
          <div class="section-title">
            <div class="t">ØªØµØ§ÙˆÛŒØ± Ù…Ø§Ù‡ÙˆØ§Ø±Ù‡â€ŒØ§ÛŒ</div>
            <div class="pill">SAT</div>
          </div>

          <div class="row2">
            <div>
              <label>Ù†ÙˆØ¹ Ù…Ø§Ù‡ÙˆØ§Ø±Ù‡</label>
              <select id="satType">
                <option value="sentinel2">Sentinel-2</option>
                <option value="landsat8">Landsat 8</option>
                <option value="landsat9">Landsat 9</option>
              </select>
            </div>
            <div>
              <label>ØªØ§Ø±ÛŒØ®</label>
              <input type="date" id="satDate" />
            </div>
          </div>

          <button class="btnx primary" style="margin-top:10px;" id="loadSatBtn">Ù†Ù…Ø§ÛŒØ´ Ù„Ø§ÛŒÙ‡ Ù…Ø§Ù‡ÙˆØ§Ø±Ù‡</button>
          <div class="help">
            Ø§ØªØµØ§Ù„ ÙˆØ§Ù‚Ø¹ÛŒ Raster Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø§Ø² GeoServer/tiles Ù…ÛŒâ€ŒØ¢ÛŒØ¯. ÙØ¹Ù„Ø§Ù‹ Ø§ÛŒÙ† Ø¯Ú©Ù…Ù‡ ÙÙ‚Ø· Ø³Ø§Ø®ØªØ§Ø± Ø±Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
          </div>

          <div class="layer-list" style="margin-top:10px;">
            <div class="layer-row">
              <div class="txt">
                <b>Satellite Layer</b>
                <small id="satLayerMeta">Ø®Ø§Ù…ÙˆØ´</small>
              </div>
              <div class="switch" id="satSwitch" title="Ø±ÙˆØ´Ù†/Ø®Ø§Ù…ÙˆØ´"></div>
            </div>
          </div>
        </div>

        <div class="section" id="panel_county" style="display:none;">
          <div class="section-title">
            <div class="t">Ù…Ø±Ø² Ø´Ù‡Ø±Ø³ØªØ§Ù†â€ŒÙ‡Ø§</div>
            <div class="pill">COUNTY</div>
          </div>

          <div class="layer-list">
            <div class="layer-row">
              <div class="txt">
                <b>Iran Counties</b>
                <small>Ø¨Ø±Ø¯Ø§Ø±ÛŒ | API: /api/fire/counties/</small>
              </div>
              <div class="switch" id="countySwitch"></div>
            </div>
          </div>

          <div class="help">Ø¨Ø§ Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ù„Ø§ÛŒÙ‡ØŒ Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø¯Ø§Ø±ÛŒ Ù‡Ù… ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
        </div>

        <div class="section" id="panel_province" style="display:none;">
          <div class="section-title">
            <div class="t">Ù…Ø±Ø² Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§</div>
            <div class="pill">PROVINCE</div>
          </div>

          <div class="layer-list">
            <div class="layer-row">
              <div class="txt">
                <b>Iran Provinces</b>
                <small>Ø¨Ø±Ø¯Ø§Ø±ÛŒ | API: /api/fire/provinces/</small>
              </div>
              <div class="switch" id="provinceSwitch"></div>
            </div>
          </div>

          <div class="help">Ø§Ú¯Ø± Ù‡Ù…Ø²Ù…Ø§Ù† Ø§Ø³ØªØ§Ù† + Ø´Ù‡Ø±Ø³ØªØ§Ù† Ø±ÙˆØ´Ù† Ø¨Ø§Ø´Ù†Ø¯ Ù‡Ø± Ø¯Ùˆ Ø±ÙˆÛŒ Ù‡Ù… Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</div>
        </div>

        <div class="section" id="panel_forest" style="display:none;">
          <div class="section-title">
            <div class="t">Ø¬Ù†Ú¯Ù„â€ŒÙ‡Ø§</div>
            <div class="pill">FOREST</div>
          </div>

          <div class="layer-list">
            <div class="layer-row">
              <div class="txt">
                <b>Iran Forests</b>
                <small>Ø¨Ø±Ø¯Ø§Ø±ÛŒ | API: /api/fire/forests/</small>
              </div>
              <div class="switch" id="forestSwitch"></div>
            </div>
          </div>

          <div class="help">Ø¨Ø±Ø§ÛŒ Ø¬Ù†Ú¯Ù„â€ŒÙ‡Ø§ Ù‡Ù… Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø¯Ø§Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ Ø§Ø³Øª.</div>
        </div>

        <div class="section" id="panel_index" style="display:none;">
          <div class="section-title">
            <div class="t">Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§</div>
            <div class="pill">INDEX</div>
          </div>

          <div class="row2">
            <div>
              <label>ØªØ§Ø±ÛŒØ®</label>
              <input type="date" id="idxDate" />
            </div>
            <div>
              <label>Ù†ÙˆØ¹ Ù…Ø§Ù‡ÙˆØ§Ø±Ù‡</label>
              <select id="idxSat">
                <option value="sentinel2">Sentinel-2</option>
                <option value="landsat8">Landsat 8</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label>Ù†ÙˆØ¹ Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ (Ú†Ù†Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ)</label>
            <div class="layer-list">
              <div class="layer-row">
                <div class="txt"><b>NDVI</b><small>Ù¾ÙˆØ´Ø´ Ú¯ÛŒØ§Ù‡ÛŒ</small></div>
                <div class="switch" data-index="NDVI"></div>
              </div>
              <div class="layer-row">
                <div class="txt"><b>NBR</b><small>Ø³ÙˆØ®ØªÚ¯ÛŒ/Ø¢ØªØ´</small></div>
                <div class="switch" data-index="NBR"></div>
              </div>
              <div class="layer-row">
                <div class="txt"><b>NDMI</b><small>Ø±Ø·ÙˆØ¨Øª</small></div>
                <div class="switch" data-index="NDMI"></div>
              </div>
            </div>
          </div>

          <button class="btnx primary" style="margin-top:10px;" id="applyIndexBtn">Ø§Ø¹Ù…Ø§Ù„ Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§</button>
          <div class="help">
            Ø³Ø§Ø®ØªØ§Ø± Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª. Ø§ØªØµØ§Ù„ Ø±Ø³ØªØ±ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø§Ø² GeoServer/MinIO Ù…ÛŒâ€ŒØ¢ÛŒØ¯ (Ø¨Ø¹Ø¯Ø§Ù‹ Ø¨Ù‡ API ÙˆØµÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…).
          </div>
        </div>

      </div>
    </aside>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Draw -->
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- Optional: KML parsing (simple) -->
  <script>
    // -------------------------
    // Map init (NO Leaflet default zoom control)
    // -------------------------
    const map = L.map('map', { zoomControl: false }).setView([32.0, 53.0], 5);

    // Base layers
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    });

    const esriSat = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { maxZoom: 19, attribution: '&copy; Esri' }
    );

    osm.addTo(map);

    // Scale
    L.control.scale({ position: 'bottomleft' }).addTo(map);

    // -------------------------
    // Our toolbar buttons
    // -------------------------
    document.getElementById('zoomIn').onclick = () => map.zoomIn();
    document.getElementById('zoomOut').onclick = () => map.zoomOut();
    document.getElementById('home').onclick = () => map.setView([32.0, 53.0], 5);

    // -------------------------
    // Sidebar drawer toggle
    // -------------------------
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      sidebarToggle.textContent = sidebar.classList.contains('collapsed') ? 'â®' : 'â¯';
    });

    // -------------------------
    // BaseMap radio logic
    // -------------------------
    const bmOSM = document.getElementById('bm_osm');
    const bmSAT = document.getElementById('bm_sat');

    function setBasemap(which){
      if(which === 'osm'){
        if(map.hasLayer(esriSat)) map.removeLayer(esriSat);
        if(!map.hasLayer(osm)) osm.addTo(map);
      } else {
        if(map.hasLayer(osm)) map.removeLayer(osm);
        if(!map.hasLayer(esriSat)) esriSat.addTo(map);
      }
    }

    bmOSM.addEventListener('change', () => bmOSM.checked && setBasemap('osm'));
    bmSAT.addEventListener('change', () => bmSAT.checked && setBasemap('sat'));

    // -------------------------
    // Hover dropdown -> click opens panel
    // -------------------------
    const panelIds = ['panel_sat','panel_county','panel_province','panel_forest','panel_index'];
    function openPanel(id){
      panelIds.forEach(pid => {
        const el = document.getElementById(pid);
        if(!el) return;
        el.style.display = (pid === id) ? 'block' : 'none';
      });
      // show style section only if vector-related panels open (or any vector layer active)
      refreshStyleVisibility();
    }

    document.querySelectorAll('.dd-item').forEach(item => {
      item.addEventListener('click', () => {
        const pid = item.getAttribute('data-panel');
        openPanel(pid);
      });
    });

    // -------------------------
    // AOI drawing (Leaflet.draw)
    // -------------------------
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Draw.Polygon(map, {
      allowIntersection: false,
      showArea: true,
      shapeOptions: {
        color: '#f59e0b',
        weight: 2,
        fillColor: '#f59e0b',
        fillOpacity: 0.12
      }
    });

    const editControl = new L.EditToolbar.Edit(map, { featureGroup: drawnItems });
    const deleteControl = new L.EditToolbar.Delete(map, { featureGroup: drawnItems });

    let aoiGeoJSON = null;

    function setAOIFromLayer(layer){
      aoiGeoJSON = layer.toGeoJSON();
    }

    map.on(L.Draw.Event.CREATED, function (e) {
      const layer = e.layer;
      drawnItems.addLayer(layer);
      // keep last AOI
      setAOIFromLayer(layer);
    });

    document.getElementById('drawAOI').addEventListener('click', () => {
      drawControl.enable();
    });

    document.getElementById('clearAOI').addEventListener('click', () => {
      drawnItems.clearLayers();
      aoiGeoJSON = null;
    });

    // Buttons inside AOI section (keep UI)
    document.getElementById('removeAoiBtn').addEventListener('click', () => {
      drawnItems.clearLayers();
      aoiGeoJSON = null;
    });

    document.getElementById('applyAoiBtn').addEventListener('click', () => {
      // placeholder: later send AOI to backend / store it
      console.log("AOI applied:", aoiGeoJSON);
      alert("AOI Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯ (Ø¯Ù…Ùˆ). Ø§ØªØµØ§Ù„ Ø¨Ù‡ API Ø¨Ø¹Ø¯Ø§Ù‹ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯.");
    });

    // -------------------------
    // KML upload (simple display)
    // (UI untouched; logic minimal)
    // -------------------------
    const kmlFileInput = document.getElementById('kmlFile');
    let kmlLayer = null;

    function parseKMLtoGeoJSON(kmlText){
      // Very light parsing via DOMParser -> Leaflet doesn't read KML natively without a plugin.
      // We'll just try to show a friendly message. Proper: use "omnivore" (mapbox) or "togeojson".
      // Here: we keep it minimal and safe.
      return null;
    }

    kmlFileInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if(!file) return;

      const text = await file.text();
      // For real parsing: include togeojson. For now, just notify.
      alert("KML Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ (Ø¯Ù…Ùˆ). Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‚ÛŒÙ‚ KMLØŒ Ù…Ø§Ú˜ÙˆÙ„ togeojson Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….");
      console.log("KML text length:", text.length);
    });

    // -------------------------
    // Vector layers (API -> GeoJSON)
    // -------------------------
    const vectorState = {
      county: { on:false, layer:null },
      province: { on:false, layer:null },
      forest: { on:false, layer:null },
    };

    function getVectorStyle(){
      const strokeColor = document.getElementById('strokeColor').value || '#22c55e';
      const fillColor = document.getElementById('fillColor').value || '#16a34a';
      const weight = Number(document.getElementById('strokeWidth').value || 2);
      const fillOpacity = Number(document.getElementById('fillOpacity').value || 0.15);

      return {
        color: strokeColor,
        weight,
        fillColor,
        fillOpacity
      };
    }

    function refreshStyleVisibility(){
      const anyVectorOn = vectorState.county.on || vectorState.province.on || vectorState.forest.on;
      const styleSection = document.getElementById('styleSection');
      styleSection.style.display = anyVectorOn ? 'block' : 'none';
    }

    async function fetchGeoJSON(url){
      const res = await fetch(url, {
        headers: {
          // Ø§Ú¯Ø± JWT Ù„Ø§Ø²Ù… Ø¯Ø§Ø±ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
          // "Authorization": `Bearer ${localStorage.getItem("access_token") || ""}`
        }
      });
      if(!res.ok){
        const txt = await res.text();
        throw new Error(`API error ${res.status}: ${txt}`);
      }
      return await res.json();
    }

    function addVectorLayer(key, geojson){
      // remove old if exists
      if(vectorState[key].layer){
        map.removeLayer(vectorState[key].layer);
      }

      const style = getVectorStyle();
      const layer = L.geoJSON(geojson, {
        style: () => style,
        onEachFeature: (feature, lyr) => {
          const name = feature?.properties?.name || feature?.properties?.NAME || "Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…";
          lyr.bindPopup(name);
        }
      });

      vectorState[key].layer = layer;
      layer.addTo(map);
      vectorState[key].on = true;
      refreshStyleVisibility();
    }

    function removeVectorLayer(key){
      if(vectorState[key].layer){
        map.removeLayer(vectorState[key].layer);
      }
      vectorState[key].layer = null;
      vectorState[key].on = false;
      refreshStyleVisibility();
    }

    // Apply style button
    document.getElementById('applyStyleBtn').addEventListener('click', () => {
      const style = getVectorStyle();
      ['county','province','forest'].forEach(k => {
        if(vectorState[k].layer){
          vectorState[k].layer.setStyle(style);
        }
      });
    });

    // Switch helpers
    function bindSwitch(el, onToggle){
      el.addEventListener('click', () => {
        el.classList.toggle('on');
        onToggle(el.classList.contains('on'));
      });
    }

    // County toggle
    bindSwitch(document.getElementById('countySwitch'), async (isOn) => {
      if(isOn){
        try{
          // Ø§Ú¯Ø± endpoint Ø´Ù…Ø§ ÙØ±Ù‚ Ø¯Ø§Ø±Ø¯ Ù‡Ù…ÛŒÙ† Ø±Ø§ Ø¹ÙˆØ¶ Ú©Ù†:
          const geojson = await fetchGeoJSON('/api/fire/counties/');
          addVectorLayer('county', geojson);
        }catch(err){
          console.error(err);
          alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø´Ù‡Ø±Ø³ØªØ§Ù†â€ŒÙ‡Ø§. Ù„Ø§Ú¯ Ø±Ø§ Ø¨Ø¨ÛŒÙ†.');
          document.getElementById('countySwitch').classList.remove('on');
        }
      } else {
        removeVectorLayer('county');
      }
    });

    // Province toggle
    bindSwitch(document.getElementById('provinceSwitch'), async (isOn) => {
      if(isOn){
        try{
          const geojson = await fetchGeoJSON('/api/fire/provinces/');
          addVectorLayer('province', geojson);
        }catch(err){
          console.error(err);
          alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§. Ù„Ø§Ú¯ Ø±Ø§ Ø¨Ø¨ÛŒÙ†.');
          document.getElementById('provinceSwitch').classList.remove('on');
        }
      } else {
        removeVectorLayer('province');
      }
    });

    // Forest toggle
    bindSwitch(document.getElementById('forestSwitch'), async (isOn) => {
      if(isOn){
        try{
          const geojson = await fetchGeoJSON('/api/fire/forests/');
          addVectorLayer('forest', geojson);
        }catch(err){
          console.error(err);
          alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¬Ù†Ú¯Ù„â€ŒÙ‡Ø§. Ù„Ø§Ú¯ Ø±Ø§ Ø¨Ø¨ÛŒÙ†.');
          document.getElementById('forestSwitch').classList.remove('on');
        }
      } else {
        removeVectorLayer('forest');
      }
    });

    // -------------------------
    // Satellite (placeholder toggle)
    // -------------------------
    const satSwitch = document.getElementById('satSwitch');
    const satMeta = document.getElementById('satLayerMeta');
    let satLayerOn = false;

    bindSwitch(satSwitch, (isOn) => {
      satLayerOn = isOn;
      satMeta.textContent = isOn ? 'Ø±ÙˆØ´Ù† (Ø¯Ù…Ùˆ) â€” Ø§ØªØµØ§Ù„ Raster Ø¨Ø¹Ø¯Ø§Ù‹' : 'Ø®Ø§Ù…ÙˆØ´';
      // later: add WMS/XYZ tile from geoserver
    });

    document.getElementById('loadSatBtn').addEventListener('click', () => {
      const type = document.getElementById('satType').value;
      const date = document.getElementById('satDate').value || 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÛŒØ®';
      satMeta.textContent = satLayerOn ? `Ø±ÙˆØ´Ù† (Ø¯Ù…Ùˆ) â€” ${type} | ${date}` : `Ø®Ø§Ù…ÙˆØ´ â€” ${type} | ${date}`;
      alert('Ø³Ø§Ø®ØªØ§Ø± Satellite Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª. Ø§ØªØµØ§Ù„ Ø¨Ù‡ GeoServer/WMS Ø±Ø§ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ….');
    });

    // -------------------------
    // Indices (placeholder multi toggles)
    // -------------------------
    const indexSwitches = document.querySelectorAll('[data-index]');
    const activeIndexes = new Set();

    indexSwitches.forEach(sw => {
      bindSwitch(sw, (isOn) => {
        const name = sw.getAttribute('data-index');
        if(isOn) activeIndexes.add(name);
        else activeIndexes.delete(name);
      });
    });

    document.getElementById('applyIndexBtn').addEventListener('click', () => {
      const date = document.getElementById('idxDate').value || 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÛŒØ®';
      const sat = document.getElementById('idxSat').value;
      alert(`Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ (Ø¯Ù…Ùˆ): ${Array.from(activeIndexes).join(', ') || 'Ù‡ÛŒÚ†'} | ${sat} | ${date}\nØ§ØªØµØ§Ù„ Ø¨Ù‡ Raster/API Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯.`);
      console.log({activeIndexes: Array.from(activeIndexes), sat, date, aoiGeoJSON});
    });

    // Default open: nothing (user chooses from hover)
    // openPanel('panel_sat');
  </script>
</body>
</html>
