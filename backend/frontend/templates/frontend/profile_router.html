{% extends "frontend/base.html" %}

{% block title %}پروفایل{% endblock %}

{% block extra_css %}
<style>
  .wrap{
    min-height: 80vh;
    display:grid;
    place-items:center;
    color: rgba(255,255,255,.85);
  }
  .box{
    width:min(520px, 94vw);
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px;
    padding: 18px 18px;
    backdrop-filter: blur(12px);
    box-shadow: 0 18px 60px rgba(0,0,0,.35);
    text-align:center;
  }
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <div class="box">
    <h3 style="margin:0 0 10px 0; font-weight:900;">در حال ورود به پروفایل…</h3>
    <div style="opacity:.7; font-size:13px;">لطفاً چند لحظه صبر کنید</div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  function getToken(){
    return localStorage.getItem("access_token") || sessionStorage.getItem("access_token");
  }
  function clearToken(){
    localStorage.removeItem("access_token");
    sessionStorage.removeItem("access_token");
    localStorage.removeItem("user_username");
    localStorage.removeItem("user_role");
  }

  function normalizeRole(roleRaw){
    const r = (roleRaw || "").toString().toLowerCase().trim();
    if (r === "مدیر" || r === "manager") return "manager";
    if (r === "کارشناس" || r === "expert") return "expert";
    if (r === "ادمین" || r === "admin") return "admin";
    return r || "unknown";
  }

  async function go(){
    const token = getToken();
    if (!token){
      window.location.href = "/ui/login/";
      return;
    }

    try{
      const res = await fetch("/api/users/myprofile/", {
        method: "GET",
        headers: { "Authorization": `Bearer ${token}` }
      });

      if (res.status === 401 || res.status === 403){
        clearToken();
        window.location.href = "/ui/login/";
        return;
      }

      const data = await res.json().catch(() => ({}));
      const username = data.username || data.user_name || "کاربر";
      const role = normalizeRole(data.role || data.Role);

      localStorage.setItem("user_username", username);
      localStorage.setItem("user_role", role);

      if (role === "manager") window.location.href = "/ui/profile/manager/";
      else if (role === "expert") window.location.href = "/ui/profile/expert/";
      else if (role === "admin") window.location.href = "/ui/profile/admin/";
      else window.location.href = "/ui/"; // fallback
    }catch(e){
      // اگر API در دسترس نبود، fallback
      const role = normalizeRole(localStorage.getItem("user_role"));
      if (role === "manager") window.location.href = "/ui/profile/manager/";
      else if (role === "expert") window.location.href = "/ui/profile/expert/";
      else if (role === "admin") window.location.href = "/ui/profile/admin/";
      else window.location.href = "/ui/";
    }
  }

  go();
</script>
{% endblock %}
