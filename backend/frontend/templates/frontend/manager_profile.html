{% extends "frontend/base.html" %}
{% load static %}

{% block title %}پروفایل مدیر | سامانه مدیریت بحران{% endblock %}

{% block extra_css %}
<style>
  /* ====== Layout / Theme ====== */
  .page{
    min-height: 100vh;
    padding: 24px 28px;
    background:
      radial-gradient(900px 450px at 75% 20%, rgba(245,158,11,.18), transparent 65%),
      radial-gradient(900px 450px at 20% 80%, rgba(59,130,246,.12), transparent 60%),
      linear-gradient(135deg, #0b1220 0%, #070a12 100%);
  }

  .topbar{
    display:flex;
    justify-content: space-between;
    align-items:center;
    gap: 16px;
    margin-bottom: 18px;
  }

  /* RIGHT title */
  .titlebox{
    display:flex;
    align-items:center;
    gap: 10px;
  }
  .titlebox h1{
    margin:0;
    color:#fff;
    font-weight: 900;
    font-size: 22px;
  }
  .titlebox .pipe{
    width: 3px;
    height: 22px;
    background: rgba(251,191,36,.95);
    border-radius: 999px;
    box-shadow: 0 0 20px rgba(251,191,36,.25);
  }

  /* LEFT user + logout */
  .user-area{
    display:flex;
    align-items:center;
    gap: 10px;
  }
  .user-chip{
    display:flex;
    align-items:center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 999px;
    text-decoration:none;
    background: rgba(255,255,255,.08);
    border: 1px solid rgba(255,255,255,.14);
    color:#fff;
    transition:.15s ease;
  }
  .user-chip:hover{
    transform: translateY(-1px);
    background: rgba(255,255,255,.12);
    border-color: rgba(251,191,36,.35);
  }
  .user-avatar{
    width: 32px; height: 32px;
    border-radius: 999px;
    display:grid; place-items:center;
    font-weight:900;
    background: rgba(251,191,36,.18);
    border: 1px solid rgba(251,191,36,.35);
    color: #fbbf24;
  }
  .user-meta{ line-height:1.1; }
  .user-name{ font-weight:900; font-size:13px; }
  .user-role{ font-size:11px; opacity:.7; margin-top:2px; }

  .btn-logout{
    border:none;
    padding: 10px 12px;
    border-radius: 999px;
    font-weight: 900;
    background: rgba(239,68,68,.18);
    border: 1px solid rgba(239,68,68,.28);
    color:#fecaca;
    transition:.15s ease;
  }
  .btn-logout:hover{ transform: translateY(-1px); background: rgba(239,68,68,.24); }

  /* ====== Cards / Grid ====== */
  .grid{
    display:grid;
    grid-template-columns: 1.05fr .95fr;
    gap: 16px;
  }
  @media (max-width: 1100px){
    .grid{ grid-template-columns: 1fr; }
  }

  .cardx{
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.14);
    border-radius: 18px;
    padding: 16px;
    backdrop-filter: blur(12px);
    box-shadow: 0 18px 60px rgba(0,0,0,.35);
    color: rgba(226,232,240,.95);
  }
  .cardx h3{
    margin:0 0 10px 0;
    font-weight: 900;
    color:#fff;
    font-size: 16px;
  }
  .muted{ color: rgba(226,232,240,.72); font-size: 13px; }

  .kv{
    display:grid;
    grid-template-columns: 140px 1fr;
    gap: 10px;
    font-size: 13px;
  }
  .kv .k{ opacity:.65; }
  .kv .v{ font-weight:800; }

  /* ====== Controls ====== */
  .btnx{
    border-radius: 12px;
    padding: 10px 12px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color: #fff;
    transition: .12s ease;
  }
  .btnx:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); }
  .btn-gold{
    border:none;
    background: linear-gradient(90deg, #fbbf24, #f59e0b);
    color:#0b1220;
    font-weight: 900;
    box-shadow: 0 10px 30px rgba(245,158,11,.18);
  }
  .btn-danger{
    background: rgba(239,68,68,.18);
    border: 1px solid rgba(239,68,68,.28);
    color:#fecaca;
  }
  .btn-danger:hover{ background: rgba(239,68,68,.24); }

  .form-control, .form-select{
    background: rgba(2,6,23,.35) !important;
    border: 1px solid rgba(148,163,184,.22) !important;
    color: #e5e7eb !important;
    border-radius: 12px !important;
    box-shadow: none !important;
  }
  .form-control:focus, .form-select:focus{
    border-color: rgba(251,191,36,.75) !important;
    box-shadow: 0 0 0 4px rgba(251,191,36,.12) !important;
  }

  /* ====== Tables / Panels ====== */
  .tablex{ width:100%; border-collapse:collapse; font-size:14px; }
  .tablex th,.tablex td{ padding:10px; border-bottom:1px solid rgba(255,255,255,.08); vertical-align: top; }
  .panel{
    margin-top:10px;
    padding:10px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.18);
    display:none;
  }

  .badge-access{
    padding:4px 10px;
    border-radius: 999px;
    font-size: 12px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    display:inline-block;
  }
  .badge-r{ border-color: rgba(59,130,246,.35); color:#bfdbfe; }
  .badge-w{ border-color: rgba(34,197,94,.35); color:#bbf7d0; }

  /* ====== Toast ====== */
  .dm-toast{
    position:fixed; left:18px; bottom:18px;
    padding:12px 14px; border-radius:14px;
    background: rgba(15,23,42,.92);
    border:1px solid rgba(255,255,255,.12);
    color:#fff; z-index:9999;
    opacity:0; transform:translateY(12px);
    transition:.2s;
    max-width: 340px;
    line-height: 1.8;
  }
  .dm-toast.info{ border-color: rgba(251,191,36,.25); }
  .dm-toast.warn{ border-color: rgba(245,158,11,.35); }
  .dm-toast.danger{ border-color: rgba(239,68,68,.35); }
</style>
{% endblock %}

{% block content %}
<div class="page">

  <div class="topbar">
    <!-- RIGHT -->
    <div class="titlebox">
      <div class="pipe"></div>
      <h1>پروفایل مدیر</h1>
    </div>

    <!-- LEFT -->
    <div class="user-area">

      <a class="user-chip" href="/ui/" title="بازگشت به پنل">
        <div class="user-avatar" id="ui-avatar">U</div>
        <div class="user-meta">
          <div class="user-name" id="ui-username">کاربر</div>
          <div class="user-role" id="ui-role">—</div>
        </div>
      </a>
        <button class="btn-logout" id="btnLogout" type="button">خروج</button>

    </div>
  </div>

  <div class="grid">

    <!-- Account -->
    <div class="cardx">
      <h3>اطلاعات حساب</h3>
      <hr style="border-color:rgba(255,255,255,.08)">
      <div class="kv">
        <div class="k">شناسه</div><div class="v" id="p_id">—</div>
        <div class="k">نام کاربری</div><div class="v" id="p_username">—</div>
        <div class="k">نقش</div><div class="v" id="p_role">—</div>
        <div class="k">ایمیل</div><div class="v" id="p_email">—</div>
        <div class="k">تاریخ عضویت</div><div class="v" id="p_joined">—</div>
        <div class="k">آخرین ورود</div><div class="v" id="p_last">—</div>
      </div>
    </div>

    <!-- Password Update -->
    <div class="cardx">
      <h3>تغییر رمز عبور</h3>
      <hr style="border-color:rgba(255,255,255,.08)">
      <div class="mb-2">
        <label class="muted">رمز فعلی</label>
        <input id="oldPass" class="form-control" type="password" placeholder="رمز فعلی">
      </div>
      <div class="mb-2">
        <label class="muted">رمز جدید</label>
        <input id="newPass" class="form-control" type="password" placeholder="رمز جدید">
      </div>
      <div class="mb-3">
        <label class="muted">تکرار رمز جدید</label>
        <input id="newPass2" class="form-control" type="password" placeholder="تکرار رمز جدید">
      </div>
      <button class="btnx btn-gold w-100" id="btnChangePass">ثبت تغییرات</button>
    </div>

    <!-- Create Group -->
    <div class="cardx" style="grid-column:1/-1;">
      <h3>ایجاد گروه</h3>
      <hr style="border-color:rgba(255,255,255,.08)">

      <div class="row g-2">
        <div class="col-md-6">
          <label class="muted">نام گروه</label>
          <input id="gName" class="form-control" placeholder="مثلاً Managers">
        </div>
        <div class="col-md-4">
          <label class="muted">سطح دسترسی</label>
          <select id="gAccess" class="form-select">
            <option value="read">read-only</option>
            <option value="write">read/write</option>
          </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button class="btnx btn-gold w-100" id="btnCreateGroup">ایجاد</button>
        </div>
      </div>
    </div>

    <!-- Users -->
    <div class="cardx">
      <h3>لیست کاربران</h3>
      <hr style="border-color:rgba(255,255,255,.08)">

      <div class="d-flex gap-2 mb-2">
        <input id="qUsers" class="form-control" placeholder="جستجو بر اساس نام کاربری...">
        <button class="btnx" id="btnSearchUsers">جستجو</button>
      </div>

      <div id="usersBox" class="muted">در حال دریافت کاربران...</div>
    </div>

    <!-- Groups -->
    <div class="cardx">
      <h3>مدیریت گروه‌ها و اعضا</h3>
      <hr style="border-color:rgba(255,255,255,.08)">
      <div id="groupsBox" class="muted">در حال دریافت گروه‌ها...</div>
    </div>

  </div>
</div>

<div id="toast" class="dm-toast"></div>
{% endblock %}

{% block extra_js %}
<script>
  /* ========= Helpers ========= */
  const toastEl = document.getElementById("toast");

  function toast(msg, type="info"){
    toastEl.className = "dm-toast " + type;
    toastEl.textContent = msg;
    toastEl.style.opacity = "1";
    toastEl.style.transform = "translateY(0)";
    setTimeout(() => {
      toastEl.style.opacity = "0";
      toastEl.style.transform = "translateY(12px)";
    }, 2400);
  }

  function getToken(){
    // چند حالت رایج (اگر قبلاً کلیدت فرق داشت)
    return localStorage.getItem("access_token")
        || localStorage.getItem("access")
        || localStorage.getItem("token")
        || "";
  }

  function clearAuth(){
    localStorage.removeItem("access_token");
    localStorage.removeItem("access");
    localStorage.removeItem("token");
    localStorage.removeItem("dm_user");
  }

  function setHeader(username, role){
    document.getElementById("ui-username").textContent = username || "کاربر";
    document.getElementById("ui-role").textContent = role || "—";
    document.getElementById("ui-avatar").textContent = (username?.[0] || "U").toUpperCase();
  }

  async function apiTry(urls, options){
    const token = getToken();
    const headers = Object.assign({}, options?.headers || {});
    headers["Content-Type"] = headers["Content-Type"] || "application/json";
    if (token) headers["Authorization"] = "Bearer " + token;

    let lastErr = null;

    for (const url of urls){
      try{
        const res = await fetch(url, { ...options, headers });

        // اگر مسیر اشتباه بود، میریم گزینه بعد
        if (res.status === 404) continue;

        if (res.status === 401){
          toast("جلسه شما منقضی شده. دوباره وارد شوید.", "warn");
          clearAuth();
          setTimeout(()=>window.location.href="/ui/login/", 700);
          throw new Error("401");
        }

        if (res.status === 403){
          const data = await res.json().catch(()=>({}));
          toast(data.detail || "شما دسترسی انجام این عملیات را ندارید.", "danger");
          throw new Error("403");
        }

        return res;
      }catch(e){
        lastErr = e;
      }
    }

    throw lastErr || new Error("No endpoint matched");
  }

  function safeGroupName(g){
    return g.name || g.group_name || g.groupName || ("Group#" + (g.id ?? ""));
  }
  function safeAccess(g){
    return (g.access_level || g.access || g.permission || "").toLowerCase();
  }
  function badgeAccess(acc){
    return acc === "write"
      ? `<span class="badge-access badge-w">خواندن/نوشتن</span>`
      : `<span class="badge-access badge-r">فقط خواندن</span>`;
  }

  /* ========= Endpoint Candidates (برای اینکه مسیرها دقیقاً همون چیزی باشه که شما ساختید) ========= */
  const EP = {
    myprofile: ["/api/users/myprofile/", "/api/users/profile/my/", "/api/users/me/"],
    users:     ["/api/users/users/", "/api/users/list/", "/api/users/"],
    groups:    ["/api/users/groups/", "/api/users/access-groups/", "/api/users/group/"],
    groupMembers: (gid) => [
      `/api/users/groups/${gid}/members/`,
      `/api/users/access-groups/${gid}/members/`,
      `/api/users/groups/${gid}/users/`,
    ],
    addMember: [
      "/api/users/groups/members/add/",
      "/api/users/group-members/add/",
      "/api/users/groups/add-member/",
    ],
    removeMember: (gid, uid) => [
      `/api/users/groups/${gid}/members/${uid}/`,
      `/api/users/groups/${gid}/remove/${uid}/`,
      `/api/users/group-members/remove/`,
    ],
    deleteGroup: (gid) => [
      `/api/users/groups/${gid}/`,
      `/api/users/groups/${gid}/delete/`,
      `/api/users/access-groups/${gid}/`,
    ],
    passwordUpdate: ["/api/users/password/update/", "/api/users/password/change/"],
  };

  /* ========= State ========= */
  let USERS = [];
  let GROUPS = [];

  /* ========= Load Profile + Guard Manager ========= */
  async function loadMe(){
    const res = await apiTry(EP.myprofile, { method:"GET" });
    const me = await res.json().catch(()=>({}));

    // ذخیره کمکی
    try{ localStorage.setItem("dm_user", JSON.stringify(me)); }catch(e){}

    const role = (me.role || "").toLowerCase();
    if (role !== "manager"){
      // اگر کاربر مدیر نیست، برگرده profile_router
      window.location.href = "/ui/profile/";
      return null;
    }

    setHeader(me.username, me.role);

    document.getElementById("p_id").textContent = me.id ?? "—";
    document.getElementById("p_username").textContent = me.username ?? "—";
    document.getElementById("p_role").textContent = me.role ?? "—";
    document.getElementById("p_email").textContent = me.email ?? "—";
    document.getElementById("p_joined").textContent = me.date_joined ?? "—";
    document.getElementById("p_last").textContent = me.last_login ?? "—";

    return me;
  }

  /* ========= Users ========= */
  async function loadUsers(q=""){
    const url = q ? `${EP.users[0]}?q=${encodeURIComponent(q)}` : EP.users[0];
    const res = await apiTry([url, ...EP.users.slice(1)], { method:"GET" });
    USERS = await res.json().catch(()=>[]);

    const box = document.getElementById("usersBox");
    if (!USERS || USERS.length === 0){
      box.innerHTML = `<div class="muted">کاربری یافت نشد.</div>`;
      return;
    }

    let html = `
      <table class="tablex">
        <thead>
          <tr>
            <th>id</th>
            <th>نام کاربری</th>
            <th>نقش</th>
            <th>ایمیل</th>
          </tr>
        </thead>
        <tbody>
    `;
    USERS.forEach(u=>{
      html += `
        <tr>
          <td>${u.id ?? "-"}</td>
          <td><b>${u.username ?? "-"}</b></td>
          <td>${u.role ?? "-"}</td>
          <td class="muted">${u.email ?? "-"}</td>
        </tr>
      `;
    });
    html += `</tbody></table>`;
    box.innerHTML = html;
  }

  function usersOptions(){
    if (!USERS || USERS.length === 0) return `<option value="">(لیست کاربران خالی است)</option>`;
    return `<option value="">انتخاب کاربر...</option>` + USERS.map(u =>
      `<option value="${u.id}">${u.username} (${u.role})</option>`
    ).join("");
  }

  /* ========= Groups ========= */
  async function loadGroups(){
    const res = await apiTry(EP.groups, { method:"GET" });
    GROUPS = await res.json().catch(()=>[]);

    const box = document.getElementById("groupsBox");
    if (!GROUPS || GROUPS.length === 0){
      box.innerHTML = `<div class="muted">هنوز گروهی ساخته نشده است.</div>`;
      return;
    }

    let html = `
      <table class="tablex">
        <thead>
          <tr>
            <th>نام گروه</th>
            <th>دسترسی</th>
            <th>عملیات</th>
          </tr>
        </thead>
        <tbody>
    `;

    GROUPS.forEach(g=>{
      const name = safeGroupName(g);
      const acc  = safeAccess(g) || "read";
      html += `
        <tr>
          <td><b>${name}</b> <span class="muted">(#${g.id})</span></td>
          <td>${badgeAccess(acc)}</td>
          <td>
            <div class="d-flex flex-wrap gap-2">
              <button class="btnx" onclick="openMembers(${g.id})">اعضا</button>
              <button class="btnx btn-danger" onclick="deleteGroup(${g.id})">حذف گروه</button>
            </div>
            <div class="panel" id="panel-${g.id}"></div>
          </td>
        </tr>
      `;
    });

    html += `</tbody></table>`;
    box.innerHTML = html;
  }

  function closeAllPanels(){
    GROUPS.forEach(g=>{
      const p = document.getElementById(`panel-${g.id}`);
      if (p){ p.style.display = "none"; p.innerHTML=""; }
    });
  }

  async function openMembers(gid){
    closeAllPanels();
    const p = document.getElementById(`panel-${gid}`);
    if (!p) return;
    p.style.display = "block";
    p.innerHTML = `<div class="muted">در حال دریافت اعضا...</div>`;

    const res = await apiTry(EP.groupMembers(gid), { method:"GET" });
    const members = await res.json().catch(()=>[]);

    const list = (!members || members.length === 0)
      ? `<div class="muted">عضوی ثبت نشده است.</div>`
      : members.map(m=>{
          const u = m.user || m;
          return `
            <div class="d-flex justify-content-between align-items-center py-1"
                 style="border-bottom:1px solid rgba(255,255,255,.06);">
              <div>• <b>${u.username ?? "-"}</b> <span class="muted">(${u.role ?? "-"})</span></div>
              <button class="btnx btn-danger" onclick="removeMember(${gid}, ${u.id})">حذف از گروه</button>
            </div>
          `;
        }).join("");

    p.innerHTML = `
      <div class="muted mb-2">مدیریت اعضای گروه #${gid}</div>

      <div class="d-flex gap-2 mb-3">
        <select class="form-select" id="addUser-${gid}">
          ${usersOptions()}
        </select>
        <button class="btnx btn-gold" onclick="addMember(${gid})">افزودن</button>
      </div>

      <div class="muted mb-2">لیست اعضا:</div>
      ${list}
    `;
  }

  async function addMember(gid){
    const sel = document.getElementById(`addUser-${gid}`);
    const user_id = parseInt(sel?.value || "0", 10);
    if(!user_id){ toast("یک کاربر انتخاب کنید.", "warn"); return; }

    // روش متداول: POST + payload
    const res = await apiTry(EP.addMember, {
      method:"POST",
      body: JSON.stringify({ group_id: gid, user_id })
    });

    const data = await res.json().catch(()=>({}));
    toast(data.detail || "کاربر به گروه اضافه شد.", "info");
    await openMembers(gid);
  }

  async function removeMember(gid, uid){
    if(!confirm("کاربر از گروه حذف شود؟")) return;

    // اول تلاش با DELETE رست‌فول
    try{
      const resDel = await apiTry([EP.removeMember(gid, uid)[0], EP.removeMember(gid, uid)[1]], { method:"DELETE" });
      if (resDel.status === 204){
        toast("کاربر از گروه حذف شد.", "info");
        await openMembers(gid);
        return;
      }
      const data = await resDel.json().catch(()=>({}));
      toast(data.detail || "حذف انجام شد.", "info");
      await openMembers(gid);
      return;
    }catch(e){
      // اگر DELETE نبود، می‌ریم سراغ POST remove
    }

    const res = await apiTry([EP.removeMember(gid, uid)[2]], {
      method:"POST",
      body: JSON.stringify({ group_id: gid, user_id: uid })
    });
    const data = await res.json().catch(()=>({}));
    toast(data.detail || "کاربر از گروه حذف شد.", "info");
    await openMembers(gid);
  }

  async function deleteGroup(gid){
    if(!confirm("گروه کامل حذف شود؟")) return;

    const res = await apiTry(EP.deleteGroup(gid), { method:"DELETE" });

    if (res.status === 204){
      toast("گروه حذف شد.", "info");
    } else {
      const data = await res.json().catch(()=>({}));
      toast(data.detail || "حذف گروه انجام شد.", "info");
    }

    await loadGroups();
  }

  async function createGroup(){
    const name = document.getElementById("gName").value.trim();
    const access_level = document.getElementById("gAccess").value;

    if(!name){ toast("نام گروه را وارد کنید.", "warn"); return; }

    const res = await apiTry(EP.groups, {
      method:"POST",
      body: JSON.stringify({ name, access_level })
    });

    const data = await res.json().catch(()=>({}));
    toast(data.detail || "گروه ایجاد شد.", "info");
    document.getElementById("gName").value = "";

    await loadGroups();
  }

  async function changePassword(){
    const old_password = document.getElementById("oldPass").value.trim();
    const new_password = document.getElementById("newPass").value.trim();
    const new_password_confirm = document.getElementById("newPass2").value.trim();

    if(!old_password || !new_password || !new_password_confirm){
      toast("همه فیلدهای رمز را کامل کنید.", "warn"); return;
    }
    if(new_password !== new_password_confirm){
      toast("رمز جدید و تکرار آن یکسان نیست.", "warn"); return;
    }

    const res = await apiTry(EP.passwordUpdate, {
      method:"POST",
      body: JSON.stringify({ old_password, new_password, new_password_confirm })
    });

    const data = await res.json().catch(()=>({}));
    toast(data.detail || "رمز با موفقیت تغییر کرد.", "info");

    document.getElementById("oldPass").value = "";
    document.getElementById("newPass").value = "";
    document.getElementById("newPass2").value = "";
  }

  /* ========= Events ========= */
  document.getElementById("btnLogout").addEventListener("click", ()=>{
    clearAuth();
    window.location.href = "/ui/login/";
  });

  document.getElementById("btnCreateGroup").addEventListener("click", createGroup);
  document.getElementById("btnChangePass").addEventListener("click", changePassword);

  document.getElementById("btnSearchUsers").addEventListener("click", async ()=>{
    const q = document.getElementById("qUsers").value.trim();
    await loadUsers(q);
  });

  /* ========= Boot ========= */
  (async function(){
    const token = getToken();
    if(!token){ window.location.href="/ui/login/"; return; }

    try{
      const me = await loadMe();
      if(!me) return;

      await loadUsers("");   // برای dropdown افزودن عضو
      await loadGroups();    // جدول گروه‌ها
    }catch(e){
      toast("خطا در ارتباط با سرور.", "danger");
    }
  })();
</script>
{% endblock %}
