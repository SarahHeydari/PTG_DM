{% extends "frontend/base.html" %}
{% load static %}

{% block title %}پنل مدیریت سامانه{% endblock %}

{% block extra_css %}
<style>
  :root{
    --dm-bg: #0b1220;
    --dm-gold: #f59e0b;
    --dm-gold2: #fbbf24;
    --dm-white: #f8fafc;
    --dm-text: rgba(226,232,240,.92);
  }

  body{
    min-height: 100vh;
    margin: 0;
    background:
      radial-gradient(1100px 550px at 75% 25%, rgba(255, 199, 0, .14), transparent 60%),
      radial-gradient(900px 520px at 20% 75%, rgba(59, 130, 246, .12), transparent 60%),
      #071226;
    overflow-x: hidden;
  }

  /* subtle stars */
  .stars{
    position: fixed; inset: 0;
    pointer-events: none;
    opacity: .55;
    background-image:
      radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.50) 50%, transparent 51%),
      radial-gradient(1px 1px at 40% 80%, rgba(255,255,255,.38) 50%, transparent 51%),
      radial-gradient(1px 1px at 70% 30%, rgba(255,255,255,.45) 50%, transparent 51%),
      radial-gradient(1px 1px at 85% 60%, rgba(255,255,255,.30) 50%, transparent 51%),
      radial-gradient(1px 1px at 25% 55%, rgba(255,255,255,.35) 50%, transparent 51%);
    animation: drift 14s ease-in-out infinite alternate;
  }
  @keyframes drift { from{ transform: translateY(0)} to{ transform: translateY(-12px)} }

  .page{
    position: relative;
    z-index: 2;
    min-height: 100vh;
    padding: 24px 28px;
  }

  .topbar{
  display:flex;
  justify-content: space-between;
  align-items: center;
  gap: 16px;
}

/* title on RIGHT */
.titlebox{
  display:flex;
  align-items:center;
  gap: 10px;
}
.titlebox h1{
  margin:0;
  color:#fff;       /* سفید */
  font-weight: 900;
  font-size: 22px;
}
.titlebox .pipe{
  width: 3px;
  height: 22px;
  background: rgba(251,191,36,.95); /* خط زرد */
  border-radius: 999px;
  box-shadow: 0 0 20px rgba(251,191,36,.25);
}

/* user + logout on LEFT */
.user-area{
  display:flex;
  align-items:center;
  gap: 10px;
}




  /* clickable user chip -> /ui/profile/ */
  .user-chip{
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 999px;
    text-decoration: none;
    background: rgba(255,255,255,.08);
    border: 1px solid rgba(255,255,255,.14);
    color: #fff;
    transition: .15s ease;
    user-select: none;
  }
  .user-chip:hover{
    transform: translateY(-1px);
    background: rgba(255,255,255,.12);
    border-color: rgba(251,191,36,.35);
  }
  .user-meta{
    display:flex;
    flex-direction: column;
    line-height: 1.1;
  }
  .user-name{ font-weight: 900; font-size: 13px; }
  .user-role{ font-size: 11px; opacity: .7; margin-top: 2px; }
  .user-avatar{
    width: 32px; height: 32px;
    border-radius: 999px;
    display: grid; place-items: center;
    font-weight: 900;
    background: rgba(251,191,36,.18);
    border: 1px solid rgba(251,191,36,.35);
    color: #fbbf24;
  }

  .btn-logout{
    border: none;
    padding: 10px 12px;
    border-radius: 999px;
    font-weight: 900;
    background: rgba(239,68,68,.18);
    border: 1px solid rgba(239,68,68,.28);
    color: #fecaca;
    transition: .15s ease;
  }
  .btn-logout:hover{
    transform: translateY(-1px);
    background: rgba(239,68,68,.24);
  }

  /* center content */
  .center{
    min-height: calc(100vh - 90px);
    display: grid;
    place-items: center;
    padding: 12px 0 0;
  }

  .cards{
    width: min(980px, 96vw);
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 18px;
  }

  @media (max-width: 980px){
    .cards{ grid-template-columns: 1fr; width: min(520px, 96vw); }
  }

  /* square-ish cards */
  .dm-card{
    background: rgba(255,255,255,.07);
    border: 1px solid rgba(255,255,255,.14);
    border-radius: 18px;
    padding: 14px;
    box-shadow: 0 18px 60px rgba(0,0,0,.35);
    backdrop-filter: blur(12px);
    min-height: 170px;
    display:flex;
    flex-direction: column;
    justify-content: space-between;
    transform: translateY(0);
    transition: transform .18s ease, background .18s ease, border-color .18s ease;
  }

  .dm-card:hover{
    transform: translateY(-3px);
    background: rgba(255,255,255,.09);
    border-color: rgba(251,191,36,.22);
  }

  .dm-card .head{
    background: rgba(148,163,184,.14);
    border: 1px solid rgba(148,163,184,.18);
    border-radius: 14px;
    padding: 18px 14px;
    text-align: center;
    color: #fff;
    font-weight: 900;
    font-size: 18px;
  }

  .dm-card .btn-enter{
    margin-top: 14px;
    border: none;
    border-radius: 14px;
    padding: 12px;
    width: 100%;
    font-weight: 900;
    background: linear-gradient(90deg, var(--dm-gold2), var(--dm-gold));
    color: #0b1220;
    box-shadow: 0 10px 30px rgba(245,158,11,.18);
    transition: transform .15s ease;
  }
  .dm-card .btn-enter:hover{ transform: translateY(-1px); }

  /* small hint */
  .hint{
    margin-top: 16px;
    text-align: center;
    font-size: 12px;
    color: rgba(226,232,240,.55);
  }
</style>
{% endblock %}

{% block content %}
<div class="stars"></div>

<div class="page">

 <div class="topbar">

  <!-- Right: title (white) -->
  <div class="titlebox">
    <div class="pipe"></div>
    <h1>پنل مدیریت سامانه</h1>
  </div>

  <!-- Left: user + logout -->
  <div class="user-area">

    <a href="/ui/profile/" class="user-chip" title="پروفایل">
      <div class="user-avatar" id="ui-avatar">U</div>

      <div class="user-meta">
        <div class="user-name" id="ui-username">کاربر</div>
        <div class="user-role" id="ui-role">—</div>
      </div>
    </a>
    <button class="btn-logout" id="btnLogout" type="button">خروج</button>

  </div>

</div>

  <div class="center">
    <div>
      <div class="cards">
        <!-- Flood -->
        <div class="dm-card">
          <div class="head">سیل</div>
          <button class="btn-enter" type="button" onclick="openSubsystem('flood')">ورود</button>
        </div>

        <!-- Earthquake -->
        <div class="dm-card">
          <div class="head">زلزله</div>
          <button class="btn-enter" type="button" onclick="openSubsystem('earthquake')">ورود</button>
        </div>

        <!-- Fire -->
        <div class="dm-card">
          <div class="head">آتش‌سوزی</div>
          <button class="btn-enter" type="button" onclick="openSubsystem('fire')">ورود</button>
        </div>
      </div>

      <div class="hint">برای ورود به هر زیرسامانه روی «ورود» کلیک کنید</div>
    </div>
  </div>

</div>

<!-- ✅ NEW: small toast for demo/test messages -->
<div id="dmToast" style="
  position:fixed; left:18px; bottom:18px; z-index:9999;
  padding:12px 14px; border-radius:14px;
  background: rgba(15,23,42,.92);
  border:1px solid rgba(255,255,255,.12);
  color:#fff; opacity:0; transform:translateY(12px);
  transition:.2s; max-width:340px; line-height:1.8;
"></div>
{% endblock %}

{% block extra_js %}
<script>
  function getToken(){
    return (
      localStorage.getItem("access_token") ||
      localStorage.getItem("access") ||
      localStorage.getItem("token") ||
      localStorage.getItem("jwt") ||
      sessionStorage.getItem("access_token") ||
      ""
    );
  }

  function clearToken(){
    localStorage.removeItem("access_token");
    sessionStorage.removeItem("access_token");
    localStorage.removeItem("access");
    localStorage.removeItem("token");
    localStorage.removeItem("jwt");

    localStorage.removeItem("user_username");
    localStorage.removeItem("user_role");
    localStorage.removeItem("dm_user");
  }

  function setUserUI(username, role){
    const u = document.getElementById("ui-username");
    const r = document.getElementById("ui-role");
    const a = document.getElementById("ui-avatar");

    const uname = username || "کاربر";
    const urole = role || "—";

    if (u) u.textContent = uname;
    if (r) r.textContent = urole;

    const letter = (uname && uname.length) ? uname[0] : "U";
    if (a) a.textContent = String(letter).toUpperCase();
  }

  /* ✅ NEW: toast (doesn't affect old UI) */
  function toast(msg){
    const t = document.getElementById("dmToast");
    if(!t) return;
    t.textContent = msg;
    t.style.opacity = "1";
    t.style.transform = "translateY(0)";
    setTimeout(()=>{ t.style.opacity="0"; t.style.transform="translateY(12px)"; }, 2200);
  }

  /* ✅ NEW: keep old behavior: only fire redirects, others show demo message */
  function openSubsystem(name){
    if(name === "fire"){
      window.location.href = "/ui/fire/";
      return;
    }
    if(name === "flood"){
      toast("زیرسامانه «سیل» هنوز آماده نیست (دمو).");
      return;
    }
    if(name === "earthquake"){
      toast("زیرسامانه «زلزله» هنوز آماده نیست (دمو).");
      return;
    }
  }

  function loadUser(){
    // 1) try API
    const token = getToken();
    if (!token){
      // اگر توکن نیست، بفرست لاگین
      window.location.href = "/ui/login/";
      return;
    }

    (async ()=>{
      try{
        const res = await fetch("/api/users/myprofile/", {
          method: "GET",
          headers: { "Authorization": `Bearer ${token}` }
        });

        if (res.status === 401 || res.status === 403){
          clearToken();
          window.location.href = "/ui/login/";
          return;
        }

        const data = await res.json().catch(() => ({}));
        const username = data.username || data.user_name || localStorage.getItem("user_username") || "کاربر";
        const role = (data.role || data.Role || localStorage.getItem("user_role") || "—");

        localStorage.setItem("user_username", username);
        localStorage.setItem("user_role", role);
        try{ localStorage.setItem("dm_user", JSON.stringify(data)); }catch(e){}

        setUserUI(username, role);
        return;
      }catch(e){
        // 2) fallback to localStorage
        const username = localStorage.getItem("user_username") || "کاربر";
        const role = localStorage.getItem("user_role") || "—";
        setUserUI(username, role);
      }
    })();
  }

  document.getElementById("btnLogout")?.addEventListener("click", () => {
    clearToken();
    window.location.href = "/ui/login/";
  });

  loadUser();
</script>
{% endblock %}
