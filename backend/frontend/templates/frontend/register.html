{% extends "frontend/base.html" %}
{% load static %}

{% block title %}ثبت‌نام | سامانه مدیریت بحران{% endblock %}

{% block extra_css %}
<style>
  /* Page background like login/dashboard */
  .dm-auth-wrap{
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 32px 16px;
    background:
      radial-gradient(900px 450px at 75% 20%, rgba(245,158,11,.18), transparent 65%),
      radial-gradient(900px 450px at 20% 80%, rgba(59,130,246,.12), transparent 60%),
      linear-gradient(135deg, #0b1220 0%, #070a12 100%);
  }

  .dm-card{
    width: min(520px, 95vw);
    border-radius: 18px;
    background: rgba(17,24,39,.55);
    border: 1px solid rgba(148,163,184,.18);
    box-shadow: 0 20px 60px rgba(0,0,0,.45);
    backdrop-filter: blur(14px);
    padding: 24px 22px;
  }

  .dm-title{
    color: #fff;
    font-weight: 800;
    margin: 0 0 6px 0;
    font-size: 20px;
    letter-spacing: .2px;
  }

  .dm-sub{
    color: rgba(226,232,240,.75);
    margin-bottom: 18px;
    font-size: 13px;
  }

  .dm-label{
    color: rgba(226,232,240,.85);
    font-size: 13px;
    margin: 12px 0 8px;
  }

  .dm-input, .dm-select{
    background: rgba(2,6,23,.35) !important;
    border: 1px solid rgba(148,163,184,.22) !important;
    color: #e5e7eb !important;
    border-radius: 12px !important;
    padding: 12px 14px !important;
    outline: none !important;
    box-shadow: none !important;
  }

  .dm-input::placeholder{ color: rgba(226,232,240,.45) !important; }

  .dm-input:focus, .dm-select:focus{
    border-color: rgba(251,191,36,.75) !important;
    box-shadow: 0 0 0 4px rgba(251,191,36,.12) !important;
  }

  /* dropdown arrow in RTL */
  .dm-select{
    cursor: pointer;
  }

  .dm-btn{
    width: 100%;
    border: 0;
    border-radius: 12px;
    padding: 12px 14px;
    font-weight: 800;
    background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%);
    color: #111827;
    transition: transform .12s ease, filter .12s ease;
    margin-top: 18px;
  }
  .dm-btn:hover{ filter: brightness(1.05); transform: translateY(-1px); }
  .dm-btn:active{ transform: translateY(0px); }

  .dm-row{
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
  }

  .dm-footer{
    margin-top: 14px;
    display: flex;
    justify-content: space-between;
    gap: 12px;
    font-size: 13px;
    color: rgba(226,232,240,.7);
  }
  .dm-footer a{
    color: rgba(251,191,36,.95);
    text-decoration: none;
  }
  .dm-footer a:hover{ text-decoration: underline; }

  .dm-alert{
    display:none;
    margin-top: 14px;
    border-radius: 12px;
    padding: 10px 12px;
    border: 1px solid rgba(251,191,36,.35);
    background: rgba(251,191,36,.12);
    color: #fde68a;
    font-size: 13px;
    line-height: 1.8;
  }

  .dm-alert.error{
    border-color: rgba(244,63,94,.35);
    background: rgba(244,63,94,.10);
    color: rgba(254,202,202,.95);
  }

  /* Optional: make native option list darker in supported browsers */
  select.dm-select option{
    background: #0b1220;
    color: #e5e7eb;
  }
</style>
{% endblock %}

{% block content %}
<div class="dm-auth-wrap">
  <div class="dm-card">

    <h1 class="dm-title">ثبت‌نام کاربر</h1>
    <div class="dm-sub">برای ساخت حساب، اطلاعات زیر را وارد کنید.</div>

    <form id="registerForm" autocomplete="off">
      <div class="dm-row">

        <div>
          <div class="dm-label">نام کاربری</div>
          <input class="form-control dm-input" type="text" id="username" placeholder="مثلاً expert1" required />
        </div>

        <div>
          <div class="dm-label">ایمیل (اختیاری)</div>
          <input class="form-control dm-input" type="email" id="email" placeholder="example@mail.com" />
        </div>

        <div>
          <div class="dm-label">نقش</div>
          <select class="form-select dm-select" id="role" required>
            <option value="manager">مدیر</option>
            <option value="expert">کارشناس</option>
            <option value="admin">ادمین</option>
          </select>
        </div>

        <div>
          <div class="dm-label">رمز عبور</div>
          <input class="form-control dm-input" type="password" id="password" placeholder="********" required />
        </div>

      </div>

      <button class="dm-btn" type="submit" id="btnRegister">ثبت‌نام</button>

      <div class="dm-alert" id="msgBox"></div>

      <div class="dm-footer">
        <a href="/ui/login/">ورود</a>
        <a href="/ui/">بازگشت به پنل</a>
      </div>
    </form>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const msgBox = document.getElementById("msgBox");

  function showMsg(text, type="info"){
    msgBox.style.display = "block";
    msgBox.classList.remove("error");
    if(type === "error") msgBox.classList.add("error");
    msgBox.innerText = text;
  }

  function clearMsg(){
    msgBox.style.display = "none";
    msgBox.innerText = "";
    msgBox.classList.remove("error");
  }

  document.getElementById("registerForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    clearMsg();

    const btn = document.getElementById("btnRegister");
    btn.disabled = true;

    const payload = {
      username: document.getElementById("username").value.trim(),
      password: document.getElementById("password").value,
      role: document.getElementById("role").value
    };

    const email = document.getElementById("email").value.trim();
    if(email) payload.email = email;

    try {
      const res = await fetch("/api/users/register/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(() => ({}));

      if(!res.ok){
        // تلاش برای نمایش پیام‌های DRF
        const detail =
          data.detail ||
          (typeof data === "string" ? data : null) ||
          Object.values(data || {}).flat().join(" | ") ||
          "ثبت‌نام ناموفق بود.";
        showMsg(detail, "error");
        btn.disabled = false;
        return;
      }

      showMsg("ثبت‌نام با موفقیت انجام شد. در حال انتقال به صفحه ورود...");
      setTimeout(() => window.location.href = "/ui/login/", 800);

    } catch (err){
      showMsg("خطای شبکه یا سرور. دوباره تلاش کنید.", "error");
      btn.disabled = false;
    }
  });
</script>
{% endblock %}
