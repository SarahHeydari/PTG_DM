{% extends "frontend/base.html" %}
{% load static %}

{% block title %}پروفایل | سامانه مدیریت بحران{% endblock %}

{% block extra_css %}
<style>
  .router-wrap{
    min-height: 100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 32px 16px;
    background:
      radial-gradient(900px 450px at 75% 20%, rgba(245,158,11,.18), transparent 65%),
      radial-gradient(900px 450px at 20% 80%, rgba(59,130,246,.12), transparent 60%),
      linear-gradient(135deg, #0b1220 0%, #070a12 100%);
  }
  .router-card{
    width: min(520px, 95vw);
    border-radius: 18px;
    background: rgba(17,24,39,.55);
    border: 1px solid rgba(148,163,184,.18);
    box-shadow: 0 20px 60px rgba(0,0,0,.45);
    backdrop-filter: blur(14px);
    padding: 22px;
    text-align: right;
  }
  .router-title{
    color:#fff;
    font-weight: 800;
    margin:0 0 8px 0;
    font-size: 18px;
  }
  .router-sub{
    color: rgba(226,232,240,.75);
    margin:0;
    font-size: 13px;
    line-height: 1.9;
  }
  .router-spinner{
    margin-top: 14px;
    width: 40px;
    height: 40px;
    border-radius: 999px;
    border: 4px solid rgba(148,163,184,.25);
    border-top-color: rgba(251,191,36,.95);
    animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .router-msg{
    margin-top: 12px;
    color: rgba(226,232,240,.8);
    font-size: 13px;
  }
</style>
{% endblock %}

{% block content %}
<div class="router-wrap">
  <div class="router-card">
    <div class="router-title">در حال انتقال به پروفایل…</div>
    <p class="router-sub">اطلاعات حساب شما بررسی می‌شود و به صفحه مناسب هدایت خواهید شد.</p>
    <div class="router-spinner" aria-label="loading"></div>
    <div class="router-msg" id="routerMsg"></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const msgEl = document.getElementById("routerMsg");

  function getToken() {
    // کلیدهای رایج (هر کدوم بود می‌گیریم)
    return localStorage.getItem("access_token")
        || localStorage.getItem("token")
        || localStorage.getItem("jwt")
        || "";
  }

  function go(url){
    window.location.replace(url);
  }

  async function run(){
    const token = getToken();
    if(!token){
      go("/ui/login/");
      return;
    }

    try{
      const res = await fetch("/api/users/myprofile/", {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        }
      });

      if(res.status === 401 || res.status === 403){
        localStorage.removeItem("access_token");
        localStorage.removeItem("token");
        localStorage.removeItem("jwt");
        go("/ui/login/");
        return;
      }

      const data = await res.json().catch(() => ({}));

      // نقش ممکنه اینجا باشه یا داخل user
      const role = (data.role) || (data.user && data.user.role) || "";
      const userObj = data.user || data;

      // برای استفاده‌ی بعدی (نمایش نام کاربر بدون ریکوئست اضافه)
      try{
        localStorage.setItem("dm_user", JSON.stringify(userObj || {}));
      }catch(e){}

      if(role === "manager"){
        go("/ui/profile/manager/");
      } else if(role === "admin"){
        go("/ui/profile/admin/");
      } else {
        go("/ui/profile/expert/");
      }

    }catch(err){
      msgEl.innerText = "خطای شبکه/سرور. دوباره تلاش کنید.";
      // اگر خواستی: برگرده داشبورد
      // setTimeout(() => go("/ui/"), 1000);
    }
  }

  run();
</script>
{% endblock %}
